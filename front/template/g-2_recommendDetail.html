<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="manifest" href="site.webmanifest" />
    <link rel="apple-touch-icon" href="icon.png" />
    <!-- Place favicon.ico in the root directory -->

    <link rel="stylesheet" href="../css/normalize.css" />
    <link rel="stylesheet" href="../css/main.css" />
    <link rel="stylesheet" href="../css/reset.css" />
    <link rel="stylesheet" href="../css/menu.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <meta name="theme-color" content="#fafafa" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />
    <title>올라 코스추천</title>
    <style>
      .container {
        width: 1200px;
        padding: 0;
        margin-top: 100px;
        margin-bottom: 100px;
      }

      .w_1 {
        width: 1200px;
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 50px;
      }

      .w_1 .score {
          font-size: 24px;
      }

      .w_1 .title{
          font-size: 50px;
          font-weight: bold;
      }

      .w_1 .season{
          font-size: 30px;
      }

      .w_1 .above{
          font-size: 24px;
      }

      .w_3 {
        margin-bottom: 100px;
      }

      .like-title {
      /*width: 70px;*/
      margin-right: 20px;
      height: 50px;
      line-height: 50px;
      font-size: 15px;
      font-weight: bold;
      /*margin-left: 10px;*/
    }



      .address{
          margin-bottom: 50px;
      }

      .w_1_1 {
        width: 1200px;
        height: 33px;
      }

      .btns {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 100px;
      }
      .btns > button {
        width: 160px;
        height: 50px;
        margin-left: 10px;
        background-color: white;
        border: 1px solid #f46b3f;
        color: #f46b3f;
      }

      .btns > button:hover {
        background-color: #f46b3f;
        border: none;
        color: white;
      }

      .disable {
          border: 1px solid #E4E4E4;
          background-color: #F1F1F1;
          color: #ADADAD;
      }
    </style>
  </head>
  <body>
    <!-- ############# 네비게이션 #############-->
    <header class="menu">
      <div class="bg-line"></div>
      <div class="logo-wrap">
        <img class="img" src="./../static/img/logo_main.png" alt="로고" />
      </div>
      <div class="item-list">
        <a href="./g-1_recommend.html" style="font-weight: bold; color: #f46b3f"
          >코스추천</a
        >
        <a href="h-1_communityMain.html">커뮤니티</a>
        <a href="./i-1_shopMain.html">쇼핑몰</a>
        <a href="./j-1_noticeMain.html">공지사항</a>
      </div>
      <div class="right">
        <div class="friend">
          <div class="icon-friend" onclick="handleToggleFriendDropBox()">
            <img class="img" src="./../static/img/icon_friends.png" />
          </div>
          <div class="friend-dropbox">
            <div class="search-area">
              <div class="mb-3">
                <input
                  type="text"
                  class="form-control"
                  id="exampleFormControlInput1"
                  placeholder="닉네임 검색"
                />
              </div>
              <div class="btn-wrap">
                <button type="button" class="btn btn-primary search-btn">
                  검색
                </button>
              </div>
            </div>
            <ul class="friend-list">
              <li>
                <div class="left">
                  <div class="img-wrap">
                    <img
                      class="img"
                      src="./../static/img/icon_profile_default.png"
                    />
                  </div>
                  <p class="name">오메가오메오메</p>
                  <button type="button" class="btn btn-link">1:1 채팅</button>
                </div>
              </li>
              <li>
                <div class="left">
                  <div class="img-wrap">
                    <img
                      class="img"
                      src="./../static/img/icon_profile_default.png"
                    />
                  </div>
                  <p class="name">오메가오메오메</p>
                  <button type="button" class="btn btn-link">1:1 채팅</button>
                </div>
              </li>
              <li>
                <div class="left">
                  <div class="img-wrap">
                    <img
                      class="img"
                      src="./../static/img/icon_profile_default.png"
                    />
                  </div>
                  <p class="name">오메가오메오메</p>
                  <button type="button" class="btn btn-link">1:1 채팅</button>
                </div>
              </li>
            </ul>
            <div class="line"></div>
            <p class="recommend-title">추천 친구</p>
            <ul class="friend-list">
              <li>
                <div class="left">
                  <div class="img-wrap">
                    <img
                      class="img"
                      src="./../static/img/icon_profile_default.png"
                    />
                  </div>
                  <p class="name">오메가오메오메</p>
                  <button type="button" class="btn btn-link">친구 추가</button>
                </div>
              </li>
              <li>
                <div class="left">
                  <div class="img-wrap">
                    <img
                      class="img"
                      src="./../static/img/icon_profile_default.png"
                    />
                  </div>
                  <p class="name">오메가오메오메</p>
                  <button type="button" class="btn btn-link">친구 추가</button>
                </div>
              </li>
              <li>
                <div class="left">
                  <div class="img-wrap">
                    <img
                      class="img"
                      src="./../static/img/icon_profile_default.png"
                    />
                  </div>
                  <p class="name">오메가오메오메</p>
                  <button type="button" class="btn btn-link">친구 추가</button>
                </div>
              </li>
              <li>
                <div class="left">
                  <div class="img-wrap">
                    <img
                      class="img"
                      src="./../static/img/icon_profile_default.png"
                    />
                  </div>
                  <p class="name">오메가오메오메</p>
                  <button type="button" class="btn btn-link">친구 추가</button>
                </div>
              </li>
              <li>
                <div class="left">
                  <div class="img-wrap">
                    <img
                      class="img"
                      src="./../static/img/icon_profile_default.png"
                    />
                  </div>
                  <p class="name">오메가오메오메</p>
                  <button type="button" class="btn btn-link">친구 추가</button>
                </div>
              </li>
              <li>
                <div class="left">
                  <div class="img-wrap">
                    <img
                      class="img"
                      src="./../static/img/icon_profile_default.png"
                    />
                  </div>
                  <p class="name">오메가오메오메</p>
                  <button type="button" class="btn btn-link">친구 추가</button>
                </div>
              </li>
            </ul>
          </div>
        </div>
        <div class="bell">
          <div class="icon-bell" onclick="handleToggleBellDropBox()">
            <img class="img" src="./../static/img/icon_bell.png" />
          </div>
          <div class="bell-dropbox">
            <p>알람</p>
            <ul>
              <li>
                <a href="#"
                  >공지사항 내용이 추가되었습니다 언능 확인해주세요!</a
                >
              </li>
              <li>
                <a href="#"
                  >공지사항 내용이 추가되었습니다 언능 확인해주세요!</a
                >
              </li>
              <li>
                <a href="#"
                  >공지사항 내용이 추가되었습니다 언능 확인해주세요!</a
                >
              </li>
              <li>
                <a href="#"
                  >공지사항 내용이 추가되었습니다 언능 확인해주세요!</a
                >
              </li>
              <li>
                <a href="#"
                  >공지사항 내용이 추가되었습니다 언능 확인해주세요!</a
                >
              </li>
              <li>
                <a href="#"
                  >공지사항 내용이 추가되었습니다 언능 확인해주세요!</a
                >
              </li>
              <li>
                <a href="#"
                  >공지사항 내용이 추가되었습니다 언능 확인해주세요!</a
                >
              </li>
              <li>
                <a href="#"
                  >공지사항 내용이 추가되었습니다 언능 확인해주세요!</a
                >
              </li>
            </ul>
          </div>
        </div>
        <a id="my-profile" class="my-profile-wrap" href="./f-1_myPage.html">
          <!--          <div class="img-wrap">-->
          <!--            <img class="img" src="./../static/img/icon_profile_default.png " />-->
          <!--          </div>-->
          <!--          <p class="text">나와바리나와바님</p>-->
        </a>
      </div>
    </header>

    <!-- ############# 작업공간 #############-->
    <main class="container">
      <section class="detailBoard">
        <!--   작업공간   -->
        <div class="wrap" id="boardWrap">
            <div id="title" class="w_1">
                <!-- 타이틀 들어갈 자리 -->
            </div>
            <div class="w_2">
                <!-- 이미지 들어갈 자리 -->
                <div style="height: 500px; overflow: hidden; display: flex; align-items: center;">
                    <img style="width: 100%;" src="./../static/img/DefaultMountain.png"  alt = "이미지" />
                </div>
            </div>
            <!-- 선 -->
            <hr style="margin-top: 30px"/>

            <!-- 좋아요 -->
            <div id="like-wrap" style="display: flex; align-items: center">
                <span class="like-title">좋아요</span>
                <div id="like-btn" style="display: flex; align-items: center; ">
                  <!-- 좋아요 버튼 자리 -->
                  <!-- <div style="width: 18px; height: 18px; display: flex; margin-right: 5px; cursor: pointer;">
                      <img style="width: 100%;" src="./../static/img/unHeart.png" alt="좋아요 이미지" />
                  </div>
                  <p style="margin-bottom: 0;">5500</p> -->
                </div>
              </div>
            <!-- <div style="display: flex;">
                  <div class="img-wrap" style="width:18px; height: 18px; margin-left:50px; margin-bottom:20px; margin-right:5px; display: flex; justify-content: center; align-items: center; overflow: hidden">
                       <img style="width: 100%" src="/static/img/unHeart.png" alt="좋아요 하트"/>
                  </div>
                  <p style="margin-bottom: 0px; font-size: 14px; font-weight: bolder">${likeCount}</p>
            </div> -->

            <!-- 주소와 내용 -->
            <div id="contents" class="w_3" >
                <!-- <div class="address">
                  <b>주소 : </b>
                  <span>${region}</span>
                </div>
                <div>
                  <span>
                    ${contents}
                  </span>
                </div> -->
              </div>
        </div>


        </div>
          <div class="btns">
              <!-- 버튼 들어갈 자리 -->
            <!-- <button
                type="button"
                class="modifyBtn btn btn-primary btn-search"
                onclick="moveModifyPage()"
            >
            수정
            </button>
            <button
                type="button"
                class="deleteBtn btn btn-primary btn-search"
                style="background-color: #F1F1F1; border: 1px solid #E4E4E4; color: #ADADAD;"
                onclick="deleteBeforeRoomCheck()"
            >
            삭제
            </button>
            <button
                type="button"
                class="btn btn-primary btn-search"
                style="background-color: #f46b3f; border: none; color: white"
                onclick="moveMainPage()"
            >
            목록
            </button> -->
          </div>
        </div>
      </section>
    </main>

    <!-- Google Analytics: change UA-XXXXX-Y to be your site's ID. -->
    <script>
      $(document).ready(function () {
        $(".friend-dropbox").hide();
        $(".bell-dropbox").hide();
        getMenuProfile();
        getRecommend();
      });
      function getMenuProfile() {
        var menuProfile = JSON.parse(localStorage.getItem("menuProfile"));
        var tempProfile = `
          <div class="img-wrap">
            <img class="img" style="width: 100%; height: auto" src=${menuProfile.profileImage ? menuProfile.profileImage : "./../static/img/icon_profile_default.png"} alt="프로필사진"/>
          </div>
          <p class="text">${menuProfile.nickname}님</p>
`;
        $("#my-profile").append(tempProfile);
      }

      function handleToggleBellDropBox() {
        $(".bell-dropbox").toggle();
        $(".friend-dropbox").hide();
      }

      function handleToggleFriendDropBox() {
        $(".friend-dropbox").toggle();
        $(".bell-dropbox").hide();
      }
      // 단건 코스조회
      function getRecommend() {
        const id = localStorage.getItem("recommendId");
        var menuProfile = JSON.parse(localStorage.getItem("menuProfile"));
        $.ajax({
          type: "GET",
          url: `http://localhost:8080/boards/recommends/${id}`,
          beforeSend: function (xlr) {
            xlr.setRequestHeader(
              "Authorization",
              localStorage.getItem("accessToken")
            );
          },
          success: function (response) {
            var menuProfile = JSON.parse(localStorage.getItem("menuProfile"));
            console.log("response : ", response);
            const score = response.score;
            const title = response.title;
            const createDate = response.createDate.substring(0, 10);
            const season = response.season;
            const altitude = response.altitude;
            const contents = response.contents;
            const region = response.region;
            const imgList = response.imgList;
            const likeCount = response.likeCount;
            const nickName = response.nickName;
            const isLike = response.isLike;
            
            //상단 타이틀
            $("#title").empty()
            var tempTitle = `
                <div class="title">
                    ${title}
                </div>
                <div class="season">
                    <span>등산하기 좋은 계절 : </span>
                    <b style="color: #f46b3f;">${season}</b>
                </div>
                <div style="margin-top:20px">점수 : ${score}.0 / 높이 : ${altitude}m</div>
            `
            $("#title").append(tempTitle);

            // 좋아요
            $("#like-btn").empty()
            if(isLike){
                var tempLike = `
                    <div style="width: 18px; height: 18px; display: flex; margin-right: 5px; cursor: pointer;" onclick="unlikeBoard()">
                        <img style="width: 100%;" src="./../static/img/heart.png" alt="좋아요 이미지" />
                    </div>
                    <p style="margin-bottom: 0;">${likeCount}</p>
                `
                $("#like-btn").append(tempLike)
            }else {
                var tempLike = `
                    <div style="width: 18px; height: 18px; display: flex; margin-right: 5px; cursor: pointer;" onclick="likeBoard()">
                        <img style="width: 100%;" src="./../static/img/unheart.png" alt="좋아요 이미지" />
                    </div>
                    <p style="margin-bottom: 0;">${likeCount}</p>
                `
                $("#like-btn").append(tempLike)
            }

            // 주소/내용
            $("#contents").empty()
            var tempContents = `
                <div class="address">
                  <b>주소 : </b>
                  <span>${region}</span>
                </div>
                <div>
                  <span>
                    ${contents}
                  </span>
                </div>
            `
            $("#contents").append(tempContents)

            // 버튼 
            $(".btns").empty()
            if(menuProfile.nickname == response.nickName){
                var tempBtn = `
                    <button
                        type="button"
                        class="modifyBtn btn btn-primary"
                        onclick="moveModifyPage()"
                    >
                    수정
                    </button>
                    <button
                        type="button"
                        class="deleteBtn btn btn-primary"
                        onclick="deleteBeforeRoomCheck()"
                    >
                    삭제
                    </button>
                    <button
                        type="button"
                        class="btn btn-primary"
                        style="background-color: #f46b3f; border: none; color: white"
                        onclick="moveMainPage()"
                    >
                    목록
                    </button>
                `
                $(".btns").append(tempBtn)
            }else{
                console.log("asdasd")
                var tempBtn = `
                    <button
                        type="button"
                        class="modifyBtn btn btn-primary"
                        style="background-color: #F1F1F1; border: 1px solid #E4E4E4; color: #ADADAD;"
                        onclick="noMove()"
                    >
                    수정
                    </button>
                    <button
                        type="button"
                        class="deleteBtn btn btn-primary"
                        style="background-color: #F1F1F1; border: 1px solid #E4E4E4; color: #ADADAD;"
                        onclick="noMove()"
                    >
                    삭제
                    </button>
                    <button
                        type="button"
                        class="btn btn-primary"
                        style="background-color: #f46b3f; border: none; color: white"
                        onclick="moveMainPage()"
                    >
                    목록
                    </button>
                `
                $(".btns").append(tempBtn)
            }
            
          }
          ,error: function (response){
            if(response.responseJSON.message.substring(0, 11) == "JWT expired"){
              regenerateToken()
            }
          }

        });
      }

      function likeBoard(){
        const id = localStorage.getItem("recommendId");
        $.ajax({
            type: "POST",
            url: `http://localhost:8080/like/recommends/${id}`,
            contentType: "application/json; charset=utf-8",
            beforeSend: function (xlr) {
                xlr.setRequestHeader(
                    "Authorization",
                    localStorage.getItem("accessToken")
                );
            },
            success: function (response) {
                getRecommend(0);
            },
            error: function (response, status, error) {
                if (response.responseJSON.message.substring(0, 11) == "JWT expired") {
                    regenerateToken()
                    likeBoard();
                }
            },
        });
      }

      function unlikeBoard(){
        const id = localStorage.getItem("recommendId");
        $.ajax({
            type: "DELETE",
            url: `http://localhost:8080/like/recommends/${id}`,
            contentType: "application/json; charset=utf-8",
            beforeSend: function (xlr) {
                xlr.setRequestHeader(
                    "Authorization",
                    localStorage.getItem("accessToken")
                );
            },
            success: function (response) {
                getRecommend();
            },
            error: function (response, status, error) {
                if (response.responseJSON.message.substring(0, 11) == "JWT expired") {
                    regenerateToken()
                    unlikeBoard();
                }
            },
        });
      }

      

      function regenerateToken(){
        var refreshToken = localStorage.getItem("refreshToken")

        $.ajax({
          type: "POST",
          url: "http://localhost:8080/auth/token/regenerate",
          contentType : "application/json; charset=utf-8",
          data: JSON.stringify({
            refreshToken: refreshToken
          }),
          success: function (response) {
            localStorage.setItem('accessToken', response.accessToken)
            localStorage.setItem("refreshToken", response.refreshToken)
            getRecommend();
          },error: function(response){
            console.log("에러 : ", response)
          }
        })
      }

      function deleteRecommend() {
        const id = localStorage.getItem("recommendId");
        console.log("id : " + id);
        $.ajax({
          type: "DELETE",
          url: `http://localhost:8080/boards/recommends/${id}`,
          contentType: "application/json; charset=utf-8",
          beforeSend: function (xlr) {
            xlr.setRequestHeader(
              "Authorization",
              localStorage.getItem("accessToken")
            );
          },
          success: function (response) {
            alert("삭제 완료");

            window.location.href = "g-1_recommend.html";
          },
          error: function (xhr) {
            console.log(
              "[requestPostBodyJson] : [error] : " + JSON.stringify(xhr)
            );
          },
        });
      }



       var imageUrlList = [];

      function imgUpload(input) {
        const accessToken = localStorage.getItem("accessToken");

        const imageInput = $("#chooseFile")[0];
        // 파일을 여러개 선택할 수 있으므로 files 라는 객체에 담긴다.
        console.log("$('#chooseFile'): ", $("#chooseFile"));
        console.log("$('#chooseFile').files: ", $("#chooseFile")[0].files);

        var formData = new FormData();
        for (var i = 0; i < imageInput.files.length; i++) {
          // formData.append("image", imageInput.files[i]);
          formData.append("multipartFile", imageInput.files[i]);
          console.log("imageInput.files[i].name : ", imageInput.files[i].name);
        }

        $.ajax({
          type: "POST",
          url: `http://localhost:8080/s3/file`,
          // dataType: "json",
          // dataType: "multipart",
          enctype: "multipart/form-data",
          // contentType: "application/json; charset=utf-8",
          processData: false,
          contentType: false,
          beforeSend: function (xlr) {
            xlr.setRequestHeader("Authorization", accessToken);
          },
          data: formData,
          xhrFields: {
            withCredentials: true, // 클라이언트와 서버가 통신할때 쿠키와 같은 인증 정보 값을 공유하겠다는 설정
          },
          success: function (response) {
            console.log("여긴 찍혀? 1");
            console.log("response", response);
            for (let i = 0; i < response.length; i++) {
              // imageUrlList.push(response[i].imgList[i]);
              imageUrlList.push(response[i]);
            }
            console.log("imageUrlList : ", imageUrlList);
            return imageUrlList;
          },
          error: function (request, status, error) {
            console.log(error);
            // "[requestPostBodyJson] : [error] : " + JSON.stringify(xhr);
          },
        });
      }
        function moveModifyPage() {
            window.location.href = "h-5_communityModify.html";
        }

        function moveMainPage() {
            window.location.href = "h-1_communityMain.html";
        }

        function noMove(){
            alert("내가 쓴 코스추천이 아닙니다.")
        }

    </script>
    <script src="https://www.google-analytics.com/analytics.js" async></script>
  </body>
</html>
