<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="manifest" href="site.webmanifest">
    <link rel="apple-touch-icon" href="icon.png">
    <!-- Place favicon.ico in the root directory -->

    <link rel="stylesheet" href="../css/normalize.css">
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/menu.css">
    <link rel="stylesheet" href="../css/reset.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <meta name="theme-color" content="#fafafa">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
          rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
          crossorigin="anonymous">

    <style>
        main{
            height: 100%;
            padding: 20px;
            position: relative;
        }
        .input-area{
            padding: 5px 20px 20px;
            display: flex;
            position: fixed;
            background-color: #ffffff;
            bottom: 0;
        }
        .input-area .input-wrap{
            width: 300px;
            margin-right: 10px;
        }
        .input-area .btn-wrap{
            width: 100px;
        }
        .input-area .btn-wrap .btn{
            width: 100%;
            background-color: #ffffff;
            border: 1px solid #F46B3F;
            color: #F46B3F;
        }
        ul{
            padding: 0;
            margin-bottom: 100px;
        }
        .my-chat,
        .other-chat{
            display: flex;
            align-items: flex-end;
            margin-bottom: 10px;
        }
        .my-chat{
            margin-left: 50px;
        }
        .other-chat{
            margin-right: 50px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            /*background-color: red;*/
        }
        .other-chat .nickname{
            font-weight: bold;
            margin-bottom: 10px;
        }
        .other-chat .wrap{
            display: flex;
            align-items: flex-end;
        }

        .time{
            font-size: 12px;
            margin-bottom: 0;
        }
        .my-chat .time{
            margin-right: 10px;
        }

        .other-chat .time{
            margin-left: 10px;
        }
        .my-chat .text-box{
            padding: 20px;
            background-color: #F46B3F;
            border-radius: 20px;
            color: #ffffff;
        }

        .other-chat .text-box{
            padding: 20px;
            background-color: #FBF0DF;
            border-radius: 20px;
            color: #000000;
        }

    </style>
</head>
<body>
<main>
    <ul>
        <div class="my-chat">
            <p class="time">11:11</p>
            <div class="text-box">내가 할 소리내가 할 소리내가 할 소리내가 할 소리내가 할 소리내가 할 소리내가 할 소리내가 할 소리내가 할 소리내가 할 소리내가 할 소리내가 할 소리내가 할 소리</div>
        </div>
        <div class="other-chat">
            <p class="nickname">다른사람</p>
            <div class="wrap">
                <div class="text-box">다른사람의 소리</div>
                <p class="time">11:11</p>
            </div>
        </div>
    </ul>

</main>
<div class="input-area">
    <div class="input-wrap">
        <input type="text" class="form-control" id="message" placeholder="입력" />
    </div>
    <div class="btn-wrap">
        <button type="button" class="btn btn-primary search-btn" onclick="send();">보내기</button>
    </div>
</div>
<script>
    // websocket 생성
    const websocket = new WebSocket("ws://localhost:8080/ws/chat");
    websocket.onmessage = onMessage;	// 소켓이 메세지를 받을 때
    websocket.onopen = onOpen;		// 소켓이 생성될때(클라이언트 접속)
    websocket.onclose = onClose;	// 소켓이 닫힐때(클라이언트 접속해제)

    //접속
    function onClose(evt) {
        console.log("close event : " + evt);
    }

    //연결해제
    function onOpen(evt) {
        console.log("open event : " + evt);
    }

    // 메세지 발신
    function onMessage(msg) {
        var data = JSON.parse(msg.data); // msg를 받으면 data 필드 안에 Json String으로 정보가 있음
        // 필요한 정보를 Json data에서 추출
        var senderId = data.senderId;
        var message = data.message;
        var time = data.time;
        var newOne = data.newOne;
        var outOne = data.outOne;
    }

    // 메세지 수신
    function send(){
        var message = document.getElementById("message").value;

        // don't send when content is empty
        // 채팅 입력 칸이 비어있지 않을 경우만 정보를 Json형태로 전송
        if(message != "") {
            let msg = {
                'receiverId' : receiverId,
                'message' : message
            }

            if(message != null) {
                websocket.send(JSON.stringify(msg));	// websocket handler로 전송(서버로 전송)
            }
            document.getElementById("message").value = '';
        }
    }

    // 채팅 내용 저장하기
    function setChatHistory(name){
        var value =[];
        document.querySelectorAll('.message-li').forEach(item => {

            var time = item.querySelector('.message-data > .message-data-time').textContent;
            var message = item.querySelector('.message').textContent;
            var senderId;
            var type = item.querySelector('.message').classList[1];
            if(type == 'my-message'){
                senderId = myId;
            } else {
                senderId = name;
            }

            data = {
                "time":time,
                "message":message,
                "senderId":senderId
            }
            value.push(data);

        })

        sessionStorage.setItem(name, JSON.stringify(value));
    };

    // insert pre chat history
    function getChatHistory(name){
        var data = JSON.parse(sessionStorage.getItem(name));

        if(data != null) {
            data.forEach(item => {
                var time = item.time;
                var message = item.message;
                var senderId = item.senderId;

                insertMessage(senderId, time, message);
            })
        }
    };
</script>
</body>
</html>
